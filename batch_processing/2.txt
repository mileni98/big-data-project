FROM bde2020/spark-master:3.0.1-hadoop3.2

# Set Python to Python3
ENV PYSPARK_PYTHON=python3

# Update apk repositories and install build dependencies
RUN apk update && \
    apk add --no-cache \
    build-base \
    python3-dev \
    libffi-dev \
    geos-dev \
    cmake \
    make \
    g++ \
    wget \
    tar

# Download and unpack GEOS source
RUN wget http://download.osgeo.org/geos/geos-3.8.0.tar.bz2 && \
    tar xjf geos-3.8.0.tar.bz2 && \
    cd geos-3.8.0 && \
    ./configure && \
    make && \
    make install

# Set environment variables so the system knows where to find GEOS
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV GEOS_DIR=/usr/local

python3 -m pip install --upgrade pip setuptools wheel

RUN pip3 install --upgrade pip && \
    pip3 install wheel shapely && \
    pip3 install --no-binary :all: apache-sedona==1.4.0

RUN pip3 install apache-sedona==1.4.0

RUN apk add --no-cache geos-dev
RUN rm -rf /geos-3.8.0.tar.bz2 /geos-3.8.0